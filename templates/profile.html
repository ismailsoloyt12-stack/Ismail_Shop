{% extends "base.html" %}

{% block title %}{{ user.username }}'s Profile - App Store{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="profile-info">
                <div class="profile-avatar-wrapper">
                    <img src="{{ user.avatar or '/static/images/default-avatar.png' }}" alt="{{ user.username }}" class="profile-avatar">
                    {% if current_user.id == user.id %}
                    <button class="avatar-edit-btn" onclick="openAvatarModal()">
                        <i class="fas fa-camera"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="profile-details">
                    <h1 class="profile-name">{{ user.username }}</h1>
                    <p class="profile-email">{{ user.email }}</p>
                    <p class="profile-bio">{{ user.bio or 'No bio yet' }}</p>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-value">{{ user.downloads_count | default(0) }}</span>
                            <span class="stat-label">Downloads</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ user.reviews_count | default(0) }}</span>
                            <span class="stat-label">Reviews</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ user.favorites_count | default(0) }}</span>
                            <span class="stat-label">Favorites</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ user.joined_date }}</span>
                            <span class="stat-label">Joined</span>
                        </div>
                    </div>
                    {% if current_user.id == user.id %}
                    <button class="btn btn-primary edit-profile-btn" onclick="openEditModal()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    {% else %}
                    <button class="btn btn-primary follow-btn" onclick="toggleFollow('{{ user.id }}')">
                        <i class="fas fa-user-plus"></i> Follow
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Tabs -->
    <div class="profile-tabs">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#downloads">
                    <i class="fas fa-download"></i> Download History
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#reviews">
                    <i class="fas fa-star"></i> Reviews
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#collections">
                    <i class="fas fa-folder"></i> Collections
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#wishlist">
                    <i class="fas fa-heart"></i> Wishlist
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#activity">
                    <i class="fas fa-clock"></i> Activity
                </a>
            </li>
            {% if current_user.id == user.id %}
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </li>
            {% endif %}
        </ul>

        <div class="tab-content">
            <!-- Downloads Tab -->
            <div class="tab-pane fade show active" id="downloads">
                <div class="downloads-grid">
                    {% for app in user_downloads %}
                    <div class="download-card">
                        <img src="{{ app.icon }}" alt="{{ app.name }}">
                        <div class="download-info">
                            <h4>{{ app.name }}</h4>
                            <p>Downloaded: {{ app.download_date }}</p>
                            <div class="download-actions">
                                <a href="/app/{{ app.id }}" class="btn btn-sm btn-outline-primary">View</a>
                                <button onclick="redownload('{{ app.id }}')" class="btn btn-sm btn-success">
                                    <i class="fas fa-redo"></i> Redownload
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Reviews Tab -->
            <div class="tab-pane fade" id="reviews">
                <div class="reviews-list">
                    {% for review in user_reviews %}
                    <div class="review-card">
                        <div class="review-header">
                            <div class="review-app">
                                <img src="{{ review.app_icon }}" alt="{{ review.app_name }}">
                                <span>{{ review.app_name }}</span>
                            </div>
                            <div class="review-rating">
                                {% for i in range(5) %}
                                    {% if i < review.rating %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <p class="review-text">{{ review.text }}</p>
                        <div class="review-meta">
                            <span>{{ review.date }}</span>
                            <span><i class="fas fa-thumbs-up"></i> {{ review.helpful_count }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Collections Tab -->
            <div class="tab-pane fade" id="collections">
                <button class="btn btn-primary mb-3" onclick="createCollection()">
                    <i class="fas fa-plus"></i> Create Collection
                </button>
                <div class="collections-grid">
                    {% for collection in user_collections %}
                    <div class="collection-card">
                        <div class="collection-header">
                            <h4>{{ collection.name }}</h4>
                            <span class="badge bg-primary">{{ collection.apps_count }} apps</span>
                        </div>
                        <p>{{ collection.description }}</p>
                        <div class="collection-preview">
                            {% for app in collection.preview_apps[:4] %}
                            <img src="{{ app.icon }}" alt="{{ app.name }}" class="collection-app-icon">
                            {% endfor %}
                        </div>
                        <div class="collection-actions">
                            <a href="/collection/{{ collection.id }}" class="btn btn-sm btn-outline-primary">View</a>
                            {% if current_user.id == user.id %}
                            <button onclick="editCollection('{{ collection.id }}')" class="btn btn-sm btn-outline-secondary">Edit</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Wishlist Tab -->
            <div class="tab-pane fade" id="wishlist">
                <div class="wishlist-grid">
                    {% for app in user_wishlist %}
                    <div class="wishlist-card">
                        <img src="{{ app.icon }}" alt="{{ app.name }}">
                        <div class="wishlist-info">
                            <h4>{{ app.name }}</h4>
                            <p class="app-category">{{ app.category }}</p>
                            <div class="wishlist-actions">
                                <a href="/app/{{ app.id }}" class="btn btn-sm btn-primary">View</a>
                                <button onclick="removeFromWishlist('{{ app.id }}')" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Activity Tab -->
            <div class="tab-pane fade" id="activity">
                <div class="activity-timeline">
                    {% for activity in user_activities %}
                    <div class="activity-item">
                        <div class="activity-icon {{ activity.type }}">
                            <i class="fas {{ activity.icon }}"></i>
                        </div>
                        <div class="activity-content">
                            <p>{{ activity.description }}</p>
                            <span class="activity-time">{{ activity.time_ago }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Settings Tab (Only for profile owner) -->
            {% if current_user.id == user.id %}
            <div class="tab-pane fade" id="settings">
                <div class="settings-section">
                    <h3>Privacy Settings</h3>
                    <div class="setting-item">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="profile-public">
                            Make profile public
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="show-downloads">
                            Show download history
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="show-collections">
                            Show collections publicly
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Notification Settings</h3>
                    <div class="setting-item">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="notify-updates">
                            App updates
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="notify-reviews">
                            Review responses
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="notify-followers">
                            New followers
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Account Settings</h3>
                    <button class="btn btn-outline-primary" onclick="changePassword()">Change Password</button>
                    <button class="btn btn-outline-danger" onclick="deleteAccount()">Delete Account</button>
                </div>

                <button class="btn btn-success mt-3" onclick="saveSettings()">Save Settings</button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" value="{{ user.username }}">
                    </div>
                    <div class="mb-3">
                        <label for="bio" class="form-label">Bio</label>
                        <textarea class="form-control" id="bio" rows="3">{{ user.bio }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" value="{{ user.location }}">
                    </div>
                    <div class="mb-3">
                        <label for="website" class="form-label">Website</label>
                        <input type="url" class="form-control" id="website" value="{{ user.website }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<style>
.profile-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.profile-header {
    margin-bottom: 30px;
}

.profile-cover {
    border-radius: 15px;
    padding: 40px;
    position: relative;
}

.profile-info {
    display: flex;
    align-items: center;
    gap: 30px;
    color: white;
}

.profile-avatar-wrapper {
    position: relative;
}

.profile-avatar {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 5px solid white;
    object-fit: cover;
}

.avatar-edit-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: white;
    color: #333;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
}

.profile-details h1 {
    margin: 0;
    font-size: 2.5em;
}

.profile-stats {
    display: flex;
    gap: 30px;
    margin: 20px 0;
}

.stat-item {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 1.5em;
    font-weight: bold;
}

.stat-label {
    display: block;
    font-size: 0.9em;
    opacity: 0.9;
}

.profile-tabs {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.downloads-grid, .wishlist-grid, .collections-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.download-card, .wishlist-card, .collection-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    gap: 15px;
    transition: transform 0.3s;
}

.download-card:hover, .wishlist-card:hover, .collection-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.download-card img, .wishlist-card img {
    width: 60px;
    height: 60px;
    border-radius: 10px;
}

.review-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.review-app {
    display: flex;
    align-items: center;
    gap: 10px;
}

.review-app img {
    width: 40px;
    height: 40px;
    border-radius: 8px;
}

.collection-preview {
    display: flex;
    gap: 5px;
    margin: 10px 0;
}

.collection-app-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
}

.activity-timeline {
    position: relative;
    padding-left: 40px;
}

.activity-item {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    position: relative;
}

.activity-item::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 30px;
    bottom: -20px;
    width: 2px;
    background: #dee2e6;
}

.activity-item:last-child::before {
    display: none;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #4361ee;
    color: white;
    position: absolute;
    left: -40px;
}

.activity-content {
    flex: 1;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
}

.activity-time {
    color: #6c757d;
    font-size: 0.9em;
}

.settings-section {
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 1px solid #dee2e6;
}

.setting-item {
    margin: 15px 0;
}

@media (max-width: 768px) {
    .profile-info {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-stats {
        justify-content: center;
    }
    
    .downloads-grid, .wishlist-grid, .collections-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function openEditModal() {
    const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
    modal.show();
}

function saveProfile() {
    const data = {
        username: document.getElementById('username').value,
        bio: document.getElementById('bio').value,
        location: document.getElementById('location').value,
        website: document.getElementById('website').value
    };
    
    fetch('/api/profile/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        }
    });
}

function toggleFollow(userId) {
    fetch(`/api/user/${userId}/follow`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        }
    });
}

function removeFromWishlist(appId) {
    fetch(`/api/wishlist/remove/${appId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        }
    });
}

function createCollection() {
    const name = prompt('Collection name:');
    if (name) {
        fetch('/api/collections/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: name })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            }
        });
    }
}

function saveSettings() {
    const settings = {
        profile_public: document.getElementById('profile-public').checked,
        show_downloads: document.getElementById('show-downloads').checked,
        show_collections: document.getElementById('show-collections').checked,
        notify_updates: document.getElementById('notify-updates').checked,
        notify_reviews: document.getElementById('notify-reviews').checked,
        notify_followers: document.getElementById('notify-followers').checked
    };
    
    fetch('/api/settings/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Settings saved successfully!');
        }
    });
}
</script>
{% endblock %}
