{% extends "base.html" %}

{% block title %}Admin Dashboard - ismail store{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
        <div class="admin-actions">
            <button class="btn btn-primary" onclick="openAddAppModal()">
                <i class="fas fa-plus"></i> Add New App
            </button>
            <button class="btn btn-secondary" onclick="exportData()">
                <i class="fas fa-download"></i> Export Data
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card gradient-1">
            <div class="stat-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="stat-content">
                <h3>{{ apps | length }}</h3>
                <p>Total Apps</p>
                <span class="stat-change positive">+12% this month</span>
            </div>
        </div>
        
        <div class="stat-card gradient-2">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_users }}</h3>
                <p>Total Users</p>
                <span class="stat-change positive">+25% this month</span>
            </div>
        </div>
        
        <div class="stat-card gradient-3">
            <div class="stat-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_downloads }}</h3>
                <p>Total Downloads</p>
                <span class="stat-change positive">+18% this month</span>
            </div>
        </div>
        
        <div class="stat-card gradient-4">
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_reviews }}</h3>
                <p>Total Reviews</p>
                <span class="stat-change positive">+30% this month</span>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>Downloads Trend</h3>
            <canvas id="downloadsChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>User Growth</h3>
            <canvas id="usersChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Category Distribution</h3>
            <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="admin-tabs">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#apps-management">
                    <i class="fas fa-mobile-alt"></i> Apps Management
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#users-management">
                    <i class="fas fa-users"></i> Users Management
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#reviews-moderation">
                    <i class="fas fa-comments"></i> Reviews Moderation
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#analytics">
                    <i class="fas fa-chart-line"></i> Analytics
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#notifications">
                    <i class="fas fa-bell"></i> Notifications
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Apps Management Tab -->
            <div class="tab-pane fade show active" id="apps-management">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="Search apps..." id="appSearch">
                    </div>
                    <div class="filter-controls">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="Games">Games</option>
                            <option value="Productivity">Productivity</option>
                            <option value="Social">Social</option>
                            <option value="Entertainment">Entertainment</option>
                        </select>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover admin-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllApps"></th>
                                <th>App</th>
                                <th>Category</th>
                                <th>Developer</th>
                                <th>Downloads</th>
                                <th>Rating</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in apps[:20] %}
                            <tr>
                                <td><input type="checkbox" class="app-checkbox" value="{{ app.id }}"></td>
                                <td>
                                    <div class="app-info">
                                        <img src="{{ app.icon }}" alt="{{ app.name }}" class="app-icon-small">
                                        <span>{{ app.name }}</span>
                                    </div>
                                </td>
                                <td>{{ app.category }}</td>
                                <td>{{ app.developer }}</td>
                                <td>{{ app.downloads | default(0) }}</td>
                                <td>
                                    <div class="rating-badge">
                                        <i class="fas fa-star text-warning"></i>
                                        {{ app.rating | default(0) | round(1) }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-primary" onclick="editApp('{{ app.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="viewAnalytics('{{ app.id }}')">
                                            <i class="fas fa-chart-bar"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteApp('{{ app.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="bulk-actions">
                    <button class="btn btn-danger" onclick="bulkDelete()">Delete Selected</button>
                    <button class="btn btn-warning" onclick="bulkSuspend()">Suspend Selected</button>
                    <button class="btn btn-success" onclick="bulkActivate()">Activate Selected</button>
                </div>
            </div>

            <!-- Users Management Tab -->
            <div class="tab-pane fade" id="users-management">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="Search users..." id="userSearch">
                    </div>
                    <div class="filter-controls">
                        <select class="form-select" id="roleFilter">
                            <option value="">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                            <option value="developer">Developer</option>
                        </select>
                    </div>
                </div>
                
                <div class="users-grid">
                    {% for user_id, user in users_db.items()[:20] %}
                    <div class="user-card">
                        <div class="user-avatar">
                            <img src="{{ user.avatar or '/static/images/default-avatar.png' }}" alt="{{ user.username }}">
                        </div>
                        <div class="user-details">
                            <h4>{{ user.username }}</h4>
                            <p>{{ user.email }}</p>
                            <div class="user-stats">
                                <span><i class="fas fa-download"></i> {{ user.downloads_count | default(0) }}</span>
                                <span><i class="fas fa-star"></i> {{ user.reviews_count | default(0) }}</span>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-sm btn-primary" onclick="viewUserProfile('{{ user_id }}')">View</button>
                                <button class="btn btn-sm btn-warning" onclick="suspendUser('{{ user_id }}')">Suspend</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user_id }}')">Delete</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Reviews Moderation Tab -->
            <div class="tab-pane fade" id="reviews-moderation">
                <div class="moderation-queue">
                    <h3>Pending Reviews</h3>
                    <div class="reviews-list">
                        {% for app in apps %}
                            {% for review in app.get('reviews', [])[:5] %}
                            <div class="review-moderation-card">
                                <div class="review-header">
                                    <div class="review-user">
                                        <img src="/static/images/default-avatar.png" alt="User">
                                        <span>{{ review.user }}</span>
                                    </div>
                                    <div class="review-app">
                                        <span>for</span>
                                        <strong>{{ app.name }}</strong>
                                    </div>
                                    <div class="review-rating">
                                        {% for i in range(5) %}
                                            {% if i < review.rating %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="review-content">
                                    <p>{{ review.comment }}</p>
                                </div>
                                <div class="review-actions">
                                    <button class="btn btn-success" onclick="approveReview('{{ review.id }}')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectReview('{{ review.id }}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                    <button class="btn btn-warning" onclick="flagReview('{{ review.id }}')">
                                        <i class="fas fa-flag"></i> Flag
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-pane fade" id="analytics">
                <div class="analytics-dashboard">
                    <div class="date-range-picker">
                        <input type="date" id="startDate" class="form-control">
                        <span>to</span>
                        <input type="date" id="endDate" class="form-control">
                        <button class="btn btn-primary" onclick="updateAnalytics()">Update</button>
                    </div>
                    
                    <div class="analytics-cards">
                        <div class="analytics-card">
                            <h4>Top Performing Apps</h4>
                            <canvas id="topAppsChart"></canvas>
                        </div>
                        <div class="analytics-card">
                            <h4>User Engagement</h4>
                            <canvas id="engagementChart"></canvas>
                        </div>
                        <div class="analytics-card">
                            <h4>Revenue Overview</h4>
                            <canvas id="revenueChart"></canvas>
                        </div>
                        <div class="analytics-card">
                            <h4>Geographic Distribution</h4>
                            <div id="geoMap"></div>
                        </div>
                    </div>
                    
                    <div class="analytics-table">
                        <h4>Detailed Metrics</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Today</th>
                                    <th>This Week</th>
                                    <th>This Month</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Page Views</td>
                                    <td>12,543</td>
                                    <td>78,234</td>
                                    <td>342,567</td>
                                    <td class="text-success">+15%</td>
                                </tr>
                                <tr>
                                    <td>Downloads</td>
                                    <td>3,421</td>
                                    <td>23,456</td>
                                    <td>98,765</td>
                                    <td class="text-success">+22%</td>
                                </tr>
                                <tr>
                                    <td>New Users</td>
                                    <td>567</td>
                                    <td>3,890</td>
                                    <td>15,234</td>
                                    <td class="text-success">+18%</td>
                                </tr>
                                <tr>
                                    <td>Revenue</td>
                                    <td>$5,432</td>
                                    <td>$34,567</td>
                                    <td>$145,678</td>
                                    <td class="text-success">+28%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div class="tab-pane fade" id="notifications">
                <div class="notification-composer">
                    <h3>Send Notification</h3>
                    <form id="notificationForm">
                        <div class="mb-3">
                            <label for="notifTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="notifTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="notifMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="notifMessage" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="notifTarget" class="form-label">Target Audience</label>
                            <select class="form-select" id="notifTarget">
                                <option value="all">All Users</option>
                                <option value="active">Active Users</option>
                                <option value="new">New Users</option>
                                <option value="premium">Premium Users</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notifType" class="form-label">Type</label>
                            <select class="form-select" id="notifType">
                                <option value="info">Information</option>
                                <option value="update">Update</option>
                                <option value="promotion">Promotion</option>
                                <option value="alert">Alert</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Send Notification</button>
                    </form>
                </div>
                
                <div class="notification-history">
                    <h3>Recent Notifications</h3>
                    <div class="notifications-list">
                        <!-- Notification items would be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings">
                <div class="settings-container">
                    <div class="settings-section">
                        <h3>General Settings</h3>
                        <div class="setting-item">
                            <label for="siteName">Site Name</label>
                            <input type="text" class="form-control" id="siteName" value="Game & App Store">
                        </div>
                        <div class="setting-item">
                            <label for="siteDescription">Site Description</label>
                            <textarea class="form-control" id="siteDescription">Your destination for amazing apps and games</textarea>
                        </div>
                        <div class="setting-item">
                            <label for="contactEmail">Contact Email</label>
                            <input type="email" class="form-control" id="contactEmail" value="admin@appstore.com">
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Features</h3>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableReviews" checked>
                            <label class="form-check-label" for="enableReviews">Enable Reviews</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableDownloads" checked>
                            <label class="form-check-label" for="enableDownloads">Enable Downloads</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableRegistration" checked>
                            <label class="form-check-label" for="enableRegistration">Enable User Registration</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableNotifications" checked>
                            <label class="form-check-label" for="enableNotifications">Enable Push Notifications</label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Security</h3>
                        <div class="setting-item">
                            <label for="maxLoginAttempts">Max Login Attempts</label>
                            <input type="number" class="form-control" id="maxLoginAttempts" value="5">
                        </div>
                        <div class="setting-item">
                            <label for="sessionTimeout">Session Timeout (minutes)</label>
                            <input type="number" class="form-control" id="sessionTimeout" value="30">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="requireEmailVerification">
                            <label class="form-check-label" for="requireEmailVerification">Require Email Verification</label>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
        <h3>Recent Activity</h3>
        <div class="activity-feed">
            {% for activity in recent_activities[:10] %}
            <div class="activity-item">
                <div class="activity-icon">
                    <i class="fas fa-circle"></i>
                </div>
                <div class="activity-content">
                    <p><strong>{{ activity.username }}</strong> {{ activity.description }}</p>
                    <span class="activity-time">{{ activity.time_ago }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add/Edit App Modal -->
<div class="modal fade" id="appModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add/Edit App</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="appForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appName" class="form-label">App Name</label>
                                <input type="text" class="form-control" id="appName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appDeveloper" class="form-label">Developer</label>
                                <input type="text" class="form-control" id="appDeveloper" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appCategory" class="form-label">Category</label>
                                <select class="form-select" id="appCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Games">Games</option>
                                    <option value="Productivity">Productivity</option>
                                    <option value="Social">Social</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Education">Education</option>
                                    <option value="Lifestyle">Lifestyle</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appPrice" class="form-label">Price</label>
                                <input type="number" class="form-control" id="appPrice" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="appDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="appDescription" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="appIcon" class="form-label">Icon URL</label>
                        <input type="url" class="form-control" id="appIcon" required>
                    </div>
                    <div class="mb-3">
                        <label for="appScreenshots" class="form-label">Screenshots (comma-separated URLs)</label>
                        <textarea class="form-control" id="appScreenshots" rows="2"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="appFeatured">
                        <label class="form-check-label" for="appFeatured">Featured App</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveApp()">Save App</button>
            </div>
        </div>
    </div>
</div>

<style>
.admin-container {
    padding: 20px;
    background: #f5f6fa;
    min-height: 100vh;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.admin-header h1 {
    margin: 0;
    color: #2c3e50;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
.gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
.gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }

.stat-icon {
    font-size: 2.5em;
    opacity: 0.8;
}

.stat-content h3 {
    margin: 0;
    font-size: 2em;
    font-weight: bold;
}

.stat-content p {
    margin: 5px 0;
    opacity: 0.9;
}

.stat-change {
    font-size: 0.9em;
    display: inline-block;
    padding: 2px 8px;
    border-radius: 5px;
    background: rgba(255,255,255,0.2);
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.chart-container h3 {
    margin-top: 0;
    color: #2c3e50;
}

.admin-tabs {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.table-controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 15px;
}

.search-box {
    flex: 1;
    max-width: 300px;
}

.filter-controls {
    display: flex;
    gap: 10px;
}

.admin-table {
    background: white;
}

.app-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.app-icon-small {
    width: 40px;
    height: 40px;
    border-radius: 8px;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.bulk-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

.users-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
}

.user-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    transition: transform 0.3s;
}

.user-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.user-avatar img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin-bottom: 15px;
}

.user-stats {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 10px 0;
    color: #6c757d;
}

.user-actions {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-top: 15px;
}

.review-moderation-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.review-user {
    display: flex;
    align-items: center;
    gap: 10px;
}

.review-user img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.review-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.analytics-dashboard {
    padding: 20px;
}

.date-range-picker {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 30px;
}

.analytics-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.analytics-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
}

.analytics-table {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
}

.notification-composer, .notification-history {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.settings-container {
    max-width: 800px;
}

.settings-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.setting-item {
    margin-bottom: 15px;
}

.recent-activity {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-top: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.activity-feed {
    margin-top: 20px;
}

.activity-item {
    display: flex;
    gap: 15px;
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    color: #4361ee;
}

.activity-time {
    color: #6c757d;
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .table-controls {
        flex-direction: column;
    }
    
    .filter-controls {
        flex-direction: column;
        width: 100%;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize Charts
document.addEventListener('DOMContentLoaded', function() {
    // Downloads Chart
    const downloadsCtx = document.getElementById('downloadsChart').getContext('2d');
    new Chart(downloadsCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Downloads',
                data: [1200, 1900, 3000, 2500, 2700, 3500, 4000],
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Users Chart
    const usersCtx = document.getElementById('usersChart').getContext('2d');
    new Chart(usersCtx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'New Users',
                data: [450, 620, 750, 890, 1020, 1250],
                backgroundColor: '#43e97b'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: ['Games', 'Productivity', 'Social', 'Entertainment', 'Education'],
            datasets: [{
                data: [35, 25, 20, 15, 5],
                backgroundColor: [
                    '#4361ee',
                    '#f72585',
                    '#4cc9f0',
                    '#4895ef',
                    '#7209b7'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
});

// Admin Functions
function openAddAppModal() {
    document.getElementById('appForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('appModal'));
    modal.show();
}

function saveApp() {
    const appData = {
        name: document.getElementById('appName').value,
        developer: document.getElementById('appDeveloper').value,
        category: document.getElementById('appCategory').value,
        price: document.getElementById('appPrice').value,
        description: document.getElementById('appDescription').value,
        icon: document.getElementById('appIcon').value,
        screenshots: document.getElementById('appScreenshots').value.split(','),
        featured: document.getElementById('appFeatured').checked
    };
    
    // Send to backend
    fetch('/api/admin/app/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(appData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        }
    });
}

function editApp(appId) {
    // Fetch app details and populate modal
    fetch(`/api/app/${appId}`)
        .then(response => response.json())
        .then(app => {
            document.getElementById('appName').value = app.name;
            document.getElementById('appDeveloper').value = app.developer;
            document.getElementById('appCategory').value = app.category;
            document.getElementById('appPrice').value = app.price || 0;
            document.getElementById('appDescription').value = app.description;
            document.getElementById('appIcon').value = app.icon;
            document.getElementById('appScreenshots').value = app.screenshots.join(',');
            document.getElementById('appFeatured').checked = app.featured;
            
            const modal = new bootstrap.Modal(document.getElementById('appModal'));
            modal.show();
        });
}

function deleteApp(appId) {
    if (confirm('Are you sure you want to delete this app?')) {
        fetch(`/api/admin/app/${appId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            }
        });
    }
}

function viewAnalytics(appId) {
    window.location.href = `/admin/analytics/${appId}`;
}

function bulkDelete() {
    const selected = Array.from(document.querySelectorAll('.app-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('Please select apps to delete');
        return;
    }
    
    if (confirm(`Delete ${selected.length} apps?`)) {
        fetch('/api/admin/apps/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ app_ids: selected })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            }
        });
    }
}

function saveSettings() {
    const settings = {
        site_name: document.getElementById('siteName').value,
        site_description: document.getElementById('siteDescription').value,
        contact_email: document.getElementById('contactEmail').value,
        enable_reviews: document.getElementById('enableReviews').checked,
        enable_downloads: document.getElementById('enableDownloads').checked,
        enable_registration: document.getElementById('enableRegistration').checked,
        enable_notifications: document.getElementById('enableNotifications').checked,
        max_login_attempts: document.getElementById('maxLoginAttempts').value,
        session_timeout: document.getElementById('sessionTimeout').value,
        require_email_verification: document.getElementById('requireEmailVerification').checked
    };
    
    fetch('/api/admin/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Settings saved successfully!');
        }
    });
}

// Search and filter functionality
document.getElementById('appSearch')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.admin-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Select all checkbox
document.getElementById('selectAllApps')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.app-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Notification form
document.getElementById('notificationForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const notification = {
        title: document.getElementById('notifTitle').value,
        message: document.getElementById('notifMessage').value,
        target: document.getElementById('notifTarget').value,
        type: document.getElementById('notifType').value
    };
    
    fetch('/api/admin/notification/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(notification)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Notification sent successfully!');
            document.getElementById('notificationForm').reset();
        }
    });
});
</script>
{% endblock %}
